{% extends 'base.html' %}

{% block content %}

<h1 class="text-3xl font-bold mb-6 text-center">Expense Chart by Category</h1>

<!-- Date Filter Dropdown -->
<div class="max-w-lg mx-auto bg-white p-4 rounded-lg shadow-md mb-6">
    <label for="dateFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Date:</label>
    <select id="dateFilter" class="border p-2 w-full rounded-lg">
        <option value="all" {% if selected_date == 'all' %}selected{% endif %}>All Dates</option>
        {% for date in all_dates %}
        <option value="{{ date }}" {% if selected_date == date %}selected{% endif %}>{{ date }}</option>
        {% endfor %}
    </select>
</div>

<!-- Chart Container -->
<div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-md">
    <canvas id="expenseChart"></canvas>
</div>

<a href="{{ url_for('index') }}" class="mt-6 block w-[250px] mx-auto text-center bg-blue-500 text-white py-2 px-6 rounded-lg shadow hover:bg-blue-600">Go back</a>

<script>
    var chart = null;
    
    // Function to update chart
    function updateChart(date) {
        fetch(`/get_chart_data/${date}`)
            .then(response => response.json())
            .then(data => {
                var expenses = data.expenses_by_category;
                var labels = Object.keys(expenses);
                var chartData = Object.values(expenses);
                
                // Update dropdown with current dates
                var dateFilter = document.getElementById('dateFilter');
                dateFilter.innerHTML = '<option value="all">All Dates</option>';
                data.all_dates.forEach(date => {
                    var option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    if (date === data.selected_date) {
                        option.selected = true;
                    }
                    dateFilter.appendChild(option);
                });
                
                // Destroy existing chart if it exists
                if (chart) {
                    chart.destroy();
                }
                
                // Create new chart
                var ctx = document.getElementById('expenseChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Expenses by Category',
                            data: chartData,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(199, 199, 199, 0.6)',
                                'rgba(83, 102, 255, 0.6)',
                                'rgba(40, 159, 64, 0.6)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)',
                                'rgba(199, 199, 199, 1)',
                                'rgba(83, 102, 255, 1)',
                                'rgba(40, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': $' + context.raw.toFixed(2);
                                    }
                                }
                            },
                            title: {
                                display: true,
                                text: date === 'all' ? 'All Expenses' : `Expenses for ${date}`
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
            });
    }
    
    // Initial chart load
    document.addEventListener('DOMContentLoaded', function() {
        var initialDate = '{{ selected_date }}';
        updateChart(initialDate);
        
        // Add event listener for date filter
        document.getElementById('dateFilter').addEventListener('change', function() {
            updateChart(this.value);
        });
    });
</script>

{% endblock %}